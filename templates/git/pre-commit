#!/usr/bin/env bash
set -euo pipefail

# Bypass check if explicit skip is requested.
if [[ "${SKIP_SECURITY_GATE:-}" == "1" ]]; then
  echo "[INFO] Security gate skipped via SKIP_SECURITY_GATE=1"
  exit 0
fi

# Bypass check if this is a dedicated AI configuration repository.
if [[ "$(git config --get ai-agent.allow-config-commits || echo "false")" == "true" ]] || [[ -f ".ai-agent-config-repo" ]]; then
  goto_security_gate=1
else
  blocked_pattern='(^|/)(\.(claude|codex|gemini|cursor)(/|$))|^\.cursorrules$|^\.claude\.json$|^AGENTS\.md$|^CLAUDE\.md$|^GEMINI\.md$|^CURSOR\.md$|^OPENCODE\.md$'

  staged_files=$(git diff --cached --name-only || true)
  if echo "$staged_files" | grep -Eiq "$blocked_pattern"; then
    flagged_files=$(echo "$staged_files" | grep -Ei "$blocked_pattern" || true)
    if [[ -n "$flagged_files" ]]; then
      echo "[BLOCKED] Commit contains local AI config/policy files that must stay local." >&2
      echo "Problematic files:" >&2
      echo "$flagged_files" >&2
      echo -e "\nTo bypass this check:" >&2
      echo "1. For this repo only: run 'git config ai-agent.allow-config-commits true'" >&2
      echo "2. One-time skip: run 'export SKIP_SECURITY_GATE=1 && git commit ...'" >&2
      echo "3. Git native skip: run 'git commit --no-verify ...'" >&2
      exit 1
    fi
  fi
fi

# Run mandatory security review gate before commit.
REPO_ROOT="$(git rev-parse --show-toplevel)"
if [[ -f "$REPO_ROOT/scripts/security-review-gate.sh" ]]; then
  gate_output="$(bash "$REPO_ROOT/scripts/security-review-gate.sh" 2>&1)" || {
    echo "[BLOCKED] Security review gate failed." >&2
    echo "$gate_output" >&2
    echo -e "\nTo bypass this gate, run:" >&2
    echo "  export SKIP_SECURITY_GATE=1 && git commit -m '...'" >&2
    echo "  (On Windows/CMD: set SKIP_SECURITY_GATE=1 && git commit -m '...')" >&2
    echo "  (On Windows/PS: \$env:SKIP_SECURITY_GATE=1; git commit -m '...')" >&2
    echo "Or use 'git commit --no-verify' to skip all hooks." >&2
    exit 1
  }
fi

exit 0
